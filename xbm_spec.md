
# LivreNoir Be Music Score (.lbm)
JSON形式で記述される汎用譜面フォーマット

## 前提
- この文書では、この種のファイルを解釈するプログラムを「解釈器」と呼ぶ。
- ファイルの記述は[JSON](https://ja.wikipedia.org/wiki/JSON)形式に倣う。従って、解釈器はJSON文字列をパースする機能を持つ必要がある。
  - JSONを利用するという点では[bmson](https://bmson-spec.readthedocs.io/en/master/)と似ているが、**互換性は無い**ので注意。
- _**MUST**_ と前置された仕様には、解釈器は必ず従わなければならない。
- _**SHOULD**_ と前置された仕様には、解釈器は可能なら従う。
- _**MAY**_ と前置された仕様には、解釈器は従ってもよい。
  - _**SHOULD**_ と _**MAY**_ が併記されている場合、解釈器は必ずどちらかに従う。

## 型の定義
### JSON プリミティブ
- `number`
  - 倍精度浮動小数点数(JSONの規格により、`infinity`及び`NaN`は使用不可)
  - _**MUST**_ プロパティによっては範囲を限定したり整数に限ったりするが、その場合は数値へ変換後に`clamp`や`truncate`を適用する(エラーにはしない)。
    - 例: 整数を要求するプロパティに小数値を記述してもよい
    - 例: `0`以上を要求するプロパティに負の値を記述してもよい
- `string`
  - `""`で囲んだ文字列
  - `string`が指定されるべきプロパティに`number`が記述されている場合
    - _**SHOULD**_ 解釈器はそれをエラーとせず単純に文字列に変換する。
      - 例: `1` -> `"1"`
    - _**MAY**_ **解釈失敗(例外を発生させる)**
- `bool`
  - `true`または`false`
### 独自プリミティブ
- `Rational`
  - 2つの整数の組として表される有理数。
    - _**MUST**_ 解釈器は分子の絶対値の上限として少なくとも`9007199254740992`(=2^53)をサポートする。
    - _**MUST**_ 解釈器は分母の上限として少なくとも`10000000000`(=10^10)をサポートする。
      - `0.3333333333`(=3,333,333,333/10,000,000,000)と`1/3`は区別される。
      - `0.33333333333`(=33,333,333,333/100,000,000,000)と`1/3`を区別する必要はない。
  - 「`number`」 「`n/d`形式の`string`」のいずれかで記述する。
  - `number`の場合
    - 一度実数として解釈したあと、更にそれに最も近い整数比の分数に変換する。
      - 例: `1.23` -> `123/100`
    - _**SHOULD**_ 分数への変換は適当な分母を上限として[Stern-Brocot木](https://en.wikipedia.org/wiki/Stern%E2%80%93Brocot_tree)(SBT)により行うことが望ましい。
  - `n/d`形式の`string`の場合
    - `n`及び`d`はそれぞれ`number`に準じた形式で、`/`の前後には任意数の空白を含めてよい。
    - `n`と`d`をそれぞれ整数に変換し、`n`を分子、`d`を分母とした分数に解釈する。
    - _**MUST**_ `/d`が省略された場合、分母は`1`とみなす。
      - _**MUST**_ `d`のみが省略された場合(例: `1/`)は**解釈失敗(例外を発生させる)**
    - _**MUST**_ `d=0`の場合は**解釈失敗(例外を発生させる)**
    - 小数部分を含む場合
	  - _**MUST**_ `n`と`d`をそれぞれ`number`と同じように小数値として解釈し、`n/d`を演算した上でその値を`number`の時と同様に整数比に変換する。
	    - 例: `1.23/3.45` -(演算)> `0.356521739130435` -(SBT変換)> `123/345`
	- 整数として解釈不能な場合
	  - _**SHOULD**_ **解釈失敗(例外を発生させる)**
	  - _**MAY**_ `0/1`として扱う。
	- 分母が上限を超える場合
	  - _**SHOULD**_ SBTにより適当な分母に制限する。
	  - _**MAY**_ **解釈失敗(例外を発生させる)**
- `Position`
  - 1つの整数(小節番号)と1つの分数の組で表される時間位置。
    - 分数部分は`0`以上の`Rational`である。
    - 小節番号が負の場合、分数部分は**絶対時刻**(楽曲冒頭からの通し/全音符1個=`header.time_base`とした割合)を意味する。
    - 小節番号が`0`以上の場合、分数部分は**その小節内の位置**(`0`以上`1`未満の相対値)を意味する。
      - 絶対時刻はこの小節内位置に**その小節の長さ**(`bars`で定義)を掛けたものになる。
      - 例えば`#001:1/2`の絶対位置は`#000`と`#001`の長さに依存して決まる。
        - ともに小節長`4/4`の場合: 絶対位置は`4/4 + 1/2 * 4/4`=`3/2`
        - ともに小節長`3/4`の場合: 絶対位置は`3/4 + 1/2 * 3/4`=`9/8`
        - `#000`が`4/4`で`#001`が`3/4`の場合: 絶対位置は`4/4 + 1/2 * 3/4`=`11/8`
    - 分数部分が負の場合
      - _**SHOULD**_ その位置のオブジェクトは無視する(存在しないものとする)。
      - _**MAY**_ **解釈失敗(例外を発生させる)**
  - `Rational`と同じか「`#b:n/d`形式の`string`」のいずれかで記述する。
  - `Rational`形式の場合は`Rational`と同じように解釈し、小節番号は`-1`にする。
    - 従って`#b:`を伴わない記述ではその記述は**絶対時刻**を表す。
  - `#b:n/d`形式の場合
    - `b`は数字(`0-9`)のみ受け付ける。`n/d`部分は`Rational`と同じ。`:`の前後には任意数の空白を含めてよい。
      - _**MUST**_ `b`に数字以外が含まれる場合は**解釈失敗(例外を発生させる)**
      - 従って`b`の値は必ず**0以上の整数**に解釈される。
    - `b`を整数に、`n/d`を`Rational`に変換し、小節番号`b`の小節内位置`n/d`と解釈する。
	- _**MUST**_ `b`は先頭の`0`を全て無視する(例: `#001` -> `#1:0/1`)
	- _**MUST**_ `n/d`が省略された場合、分数部分は`0/1`と見なす。
	  - _**MUST**_ `n/d`を省略する場合、`:`も省略できる。
## 特殊記法
- `T[]`
  - `T`型の配列
  - 配列の要素の型は全て`T`でなければならない。
    - _**MUST**_ JSONの仕様上、実際に記述される要素の型は制限されないが、`T`に解釈できない要素は**無視**する。
- `{T1: T2}`
  - `T1`型のキーと`T2`型の値を持つ連想配列
  - JSONの仕様上、これは実際には単なる`JSON object`として記述される。
    - _**MUST**_ 実際に記述されるキー(プロパティ名)は全て`string`であるが、`T1`として解釈できない名前のプロパティは**無視**する。
    - _**MUST**_ 実際に記述される値(プロパティ)の型は制限されないが、`T2`に解釈できない値を持つプロパティは**無視**する。
- `T1 | T2`
  - `T1`または`T2`
- `T1 < T2`
  - `T2`を継承した型`T1`(`T1`は`T2`が持つ全てのプロパティを持つ)
## 要求される型とそのデフォルト値
- 以下は全て _**MUST**_
- `number` : `0`
- `string` : `""`
- `bool` : `false`
- `Rational` : `0/1`
- `Position` : `#000:0/1`
- その他のオブジェクト : `null`
- デフォルト値が明示される場合はこの限りでない。

# オブジェクト一覧
- 全てのオブジェクトは、`note`という名前の`string`型プロパティを持つことができる。
- これはそのオブジェクトについてのメモ書きで、ゲームプレイには影響しない。

## overview
```
object BaseData
{
	"bars"   : {number: string}, // 拍子のリスト
	"sounds" : {number: string|Sound}, // 音声データのリスト
	"images" : {number: string|Image}, // 映像データのリスト
	"conductors"  : {Position: Conductor}, // テンポ変化に関わるノートのリスト
	"sound_notes" : Note[],      // 音声ノートのリスト
	"meta_notes"  : MetaNote[],  // その他のメタノートのリスト
}
object LbmData < BaseData
{
	"header" : Header, // 楽曲情報をまとめたオブジェクト
	"params"   : {number: string}, // ランダム分岐用の値のリスト
	"branches" : BranchData[],     // ランダム分岐枝のリスト
}
object BranchData < BaseData
{
	"condition" : string, // この分岐を採用する条件
}
object Header
{
	"genre"     : string,
	"title"     : string,
	"subtitle"  : string,
	"artist"    : string,
	"subartist" : string,
	"comment"   : string,
	"time_base"   : Rational, // 絶対時刻と停止時間の時間単位
	"display_bpm" : string,
	"chart_type" : string,
	"ln_type"    : number,
	"difficulty" : number,
	"level"      : number,
	"judge"      : number,
	"total"	     : number,
	"preview"    : number|string|Sound,
	"jacket"     : number|string|Image,
	"banner"     : number|string|Image,
	"splash"     : number|string|Image,
	"background" : number|string|Image,
}
object Sound
{
	"filename" : string,
	"offset" : number,  // 再生開始位置
	"length" : number,  // 再生時間
	"volume" : number,
	"pan"    : number,
	"pitch"  : number,
}
object Image
{
	"filename" : string,
	"offset" : number,
	"length" : number,
	"cx" : number,  // 切り抜き位置
	"cy" : number,
	"cw" : number,
	"ch" : number,
}
object Conductor
{
	"y" : Position,
	"bpm" : number,
	"stop"  : Rational,
	"scroll" : number,
}
object Note
{
	"y" : Position,
	"x" : number,
	"i" : number,
	"t" : number,
	"g" : number,
	"lt" : number,
	"o" : number,  // 再生開始位置
	"l" : number,  // 再生時間
}
object MetaNote
{
	"y" : Position,
	"x" : number,
	"i" : number,
	"v" : number,
	"dx" : number, // 描画位置
	"dy" : number,
	"ox" : number, // 描画基準点
	"oy" : number,
	"angle" : number, // 回転角度
	"ax" : number, // 回転中心
	"ay" : number,
}
```

## 基本データ
`LbmData`と`BranchData`の継承元となる基本のデータ型。
```
object BaseData
{
	"bars"   : {number: string},
	"sounds" : {number: string|Sound},
	"images" : {number: string|Image},

	"conductors"  : {Position: Conductor},
	"sound_notes" : Note[],
	"meta_notes"  : MetaNote[],
}
```
- プロパティは全て省略可能。
  - _**MUST**_ 省略されているプロパティは**空の(連想)配列**として扱う。
- `bars` : `{number: string}`
  - 小節番号(`0`以上の整数)をキー、`n/d`形式で表した拍子を値とする連想配列。
    - 注意: この「拍子」は`Rational`ではない(約分しない)が、必要に応じて`Rational`に変換する。
  - `n`及び`d`には数字(`0-9`)のみを受け付ける。`/`の前後には任意数の空白を含めてよい。
    - _**MUST**_ 数字以外が含まれる場合は**解釈失敗(例外を発生させる)**
  - _**MUST**_ `#000`(楽曲開始時)の拍子が未指定の場合は`4/4`とみなす。
  - _**MUST**_ 拍子が未指定の小節は、その直前の小節の拍子を継承する。
- `sounds` : `{number: string|Sound}`
  - ID(任意の整数)をキー、音声データを値とする連想配列。
  - `Note`から参照される。
  - _**MUST**_ 値が`string`の場合、`filename`がその値であり、それ以外のプロパティが全てデフォルト値である`Sound`とみなす。
- `images` : `{number: string|Image}`
  - ID(任意の整数)をキー、映像データを値とする連想配列。
    - IDは`sounds`のものと重複してもよい。
  - `MetaNote`から参照される。
  - _**MUST**_ 値が`string`の場合、`filename`がその値であり、それ以外のプロパティが全てデフォルト値である`Image`とみなす。
- `conductors` : `{Position: Conductor}`
  - 時刻(`Position`)をキー、`Conductor`(テンポ変化に関わるオブジェクト)を値とする連想配列。
  - オブジェクトのキーは重複できないので、必然的に同じ時刻に複数の指揮者ノートが存在することはありえない。
  - _**MUST**_ `#000:0/1`(楽曲開始時)のテンポが未指定の場合は`120bpm`とみなす。
- `sound_notes` : `Note[]`
  - `Note`(音声オブジェクト)の配列。
- `meta_notes` : `MetaNote[]`
  - `MetaNote`(音声以外の汎用オブジェクト)の配列。

## ルートデータ
LBMの本体データの型。`BaseData`に加えていくつかのヘッダ情報を含む。
```
object LbmData < BaseData
{
	"header" : Header,

	/* (BaseDataから継承されたプロパティ) */

	"params"   : {number: string},
	"branches" : BranchData[],
}
```
- `header`以外は省略可能。
- `header` : `Header`
  - 楽曲に関する情報などをまとめたヘッダー。
  - _**MUST**_ プロパティが省略されているか`Header`として解釈できない場合、**解釈失敗(例外を発生させる)**
- `params` : `{number: string}`
  - ID(任意の整数)をキー、**数式**を値とする連想配列。
    - 数式の記法及び解釈方法は後述。
  - `BranchData`の採用判定に使う値のリスト。
  - 数式に`rand`を含めることで、BMSにおける`#RANDOM`分岐を再現できる。
  - _**MUST**_ 解釈器は、この譜面を実際に再生する直前に、`params`に記述された全ての数式を評価してその値を確定する。
- `branches` : `BranchData[]`
  - `BranchData`(条件による分岐枝)の配列。
  - _**SHOULD**_ 解釈器は、この譜面を実際に再生する直前、**`params`の決定後**に、全ての分岐枝についてそれを採用するか無視するかを決定する。
    - _**MAY**_ 解釈機は、これら分岐枝の選定を演奏中に行ってもよい。その場合、現在の得点に応じた分岐などが可能と想定される。
	- _**MUST**_ 演奏開始前に採用可否を決定可能な分岐枝は、必ず演奏開始前に決定する。

## 分岐枝データ
`LbmData.branches`の要素となるデータの型。分岐採用判定用のプロパティを持つ。
```
object BranchData < BaseData
{
	"condition" : string,

	/* (BaseDataから継承されたプロパティ) */
}
```
- `condition` : `string`
  - この分岐を採用するか否かを決定するための**数式**。
  - _**MUST**_ 数式の評価値が **`0`でない**場合に、解釈器はこの枝を採用する。
  - _**MUST**_ 省略された場合、解釈器はこの枝を常に無視する。

## ヘッダー
LBMのヘッダー情報をまとめたデータの型。
```
object Header
{
	"genre"     : string,
	"title"     : string,
	"subtitle"  : string,
	"artist"    : string,
	"subartist" : string,
	"comment"   : string,
	
	"time_base"   : Rational,
	"display_bpm" : string,

	"chart_type" : string,
	"ln_type"    : number,
	"difficulty" : number,
	"level"      : number,
	"judge"      : number,
	"total"	     : number,

	"preview"    : number|string|Sound,
	"jacket"     : number|string|Image,
	"banner"     : number|string|Image,
	"splash"     : number|string|Image,
	"background" : number|string|Image,
}
```
- 明記されない限り、そのプロパティは省略可能。
- `genre` : `string`
  - この楽曲のジャンル名。
  - 「ジャンル」の定義は表現者の解釈に委ねられる。
- `title` : `string`
  - **省略不可**
  - この楽曲の題名。
  - _**SHOLD**_ このプロパティが省略されているか空文字列の場合、解釈器はこの楽曲を**存在しないもの**と扱ってよい。
  - _**MUST**_ `title`と`artist`がそれぞれ完全に一致するLBMデータが**同一フォルダ内**に存在する場合、解釈器はそれらを**同じ曲の異なる譜面バリエーション**とみなす。
- `subtitle` : `string`
  - この楽曲の副題。
  - 副題に何を記述すべきかは規定されない。
  - _**MAY**_ 解釈器は、楽曲の一覧を作る際、`subtitle`の値を一覧に表示しなくてよい。
- `artist` : `string`
  - **省略不可**
  - この楽曲の作成者。
  - _**SHOLD**_ このプロパティが省略されているか空文字列の場合、解釈器はこの楽曲を**存在しないもの**と扱ってよい。
- `subartist` : `string`
  - この楽曲の補助作成者。
  - 補助作成者とは誰のことかは規定されない。
- `comment` : `string`
  - この楽曲あるいは譜面についての一言コメント。
- `time_base` : `Rational`
  - `Position`を絶対時刻で表記する際の、その単位。
  - _**MUST**_ 解釈器は、この値を**4/4拍子における全音符1個の長さ**を表すものと解釈する。
  - _**MUST**_ 省略された場合は`1/1`とみなす。
- `display_bpm` : `string`
  - 選曲画面などに表示する**見かけの**テンポ。
  - _**MUST**_ 解釈器は、このプロパティが存在する場合は(実際のテンポを無視して)この値を表示する。
  - _**MUST**_ 省略された場合は`XbmData.conductors`から表示するべき値を推測する。
- `chart_type` : `string`
  - この譜面の形式。表現方法は[bmson](https://bmson-spec.readthedocs.io/en/master/)の`mode_hint`に準ずる。
  - _**MUST**_ 解釈機は、この値が等しい譜面同士はそれぞれ同じ形式の譜面であるとみなす。
  - _**SHOULD**_ 省略された場合は`XbmData.sound_notes`の配置から推測する。
  - _**SHOULD**_ 推奨される値の解釈は以下の通り。ただしこれに従わなくてもよい。
    - `beat-5k` `beat-10k` : いわゆる5鍵のシングル/ダブルプレイ譜面
	- `beat-7k` `beat-14k` : いわゆる7鍵のシングル/ダブルプレイ譜面
	- `popn-3k` : Popn系のバトル譜面
	- `popn-5k` `popn-9k` : Popn系のシングルプレイ譜面
	- `generic-24k` : 24鍵キーボード用譜面
- `ln_type` : `number`
  - 譜面全体を通して適用されるロングノートの形式を表す整数。
  - `Note.lt`のデフォルト値として参照される。
  - _**SHOULD**_ 推奨/想定される値の解釈は以下の通り。
    - `0` : 自動判定
	  - 解釈器が自身のオプションなどを元に自由に決定する。
	- `1` : LN / ロングノート
	  - 始端ノートを処理した時点で仮の判定が発生する。
	  - 終端ノートが通過するまで対応するボタンを押し続けていれば、仮の判定がそのまま始端ノートの判定として確定する。通過する前にボタンを離した場合は、始端ノートがミス判定になる。
	  - 終端ノートは総ノート数やコンボ数に計上しない。
	- `2` : CN / チャージノート
	  - 始端ノートを処理した時点で始端ノートの判定は確定する。
	  - 終端ノートに個別の判定タイミングがあり、ボタンを「離した」時点で終端ノートの判定が確定する。
	  - 1つのロングノートにつき始端と終端の2つのノート/コンボに数える。
	  - 2方向入力が可能なデバイスの場合は**逆向き**の入力をもって「離した」と判定してもよい。
	- `3` : HCN / 持続判定チャージノート
	  - 基本的には CN と同様。
	  - ボタンを押している間はゲージが持続的に増加する。
	  - 途中でボタンを離した場合、終端ノートが通過するまでゲージが持続的に減少する。
	  - 途中でボタンを離しても、再び押し直せばゲージは回復に転向する。
	- 上記以外の値は全て`0`とみなす。
- `difficulty` : `number`
  - 難易度分類を表す整数。
  - 選曲画面等でのソート用の値であり、ゲームプレイには影響しない。
  - _**SHOULD**_ 推奨/想定される値の解釈は以下の通り。
    - `0` : 難易度未設定
	- `1` : Beginner / Easy
	- `2` : Normal / Standard
	- `3` : Hyper / Advanced
	- `4` : Another / Extreme
	- `5` : Insane
  - _**MAY**_ 解釈器は`string`形式の難易度を許可してもよい。
- `level` : `number`
  - 難易度を表現する数値。
  - 選曲画面等でのソート用の値であり、ゲームプレイには影響しない。
  - _**MUST**_ 値が大きいほど高難度であることを表す。
    - その範囲や形式(整数か実数か)は規定されない。
  - _**SHOLD**_ 推奨される値の範囲は以下の通り。`chart_type`によって異なる。
    - `beat-5k` `beat-10k` : `1-8`の整数
	- `beat-7k` `beat-14k` : `1-12`の整数
	- `popn`系 : `1-50`の整数
  - _**SHOULD**_ レベル`0`は最低難度ではなく**難度未指定**を意味する。
- `judge` : `number`
  - 判定幅の補正。通常の判定幅を`100`とした数値で表す。
    - 「通常の判定幅」がなんであるかは解釈器の判断に委ねられる。
  - _**MUST**_ 値が大きいほど判定が「緩く」なる。小さいほど判定は「厳しく」なる。
  - _**MUST**_ `0`未満の値は`0`に矯正する。
  - _**MUST**_ 省略された場合は`100`とみなす。
  - _**MAY**_ 解釈器はこの指定値を記載通りの倍率とみなさなくてもよい。
    - 例: `50`は判定幅が半分になるのではなく、最高判定の幅が1フレームになる。
- `total` : `number`
  - 全てのノートを最高判定で処理した場合に回復するゲージの総量を **%単位** で表す。
  - _**MUST**_ `0`未満の値は`0`に矯正する。
  - _**MAY**_ 解釈器は(ゲームモードによっては)この指定を無視して独自に計算してもよい。
  - 省略された場合は解釈器が独自に決定してよい。
    - 参考: beat系では `TOTAL = Max(Int(760.5 * NOTES / (NOTES + 650)), 260)`
- `preview` : `number|string|Sound`
  - 選曲画面等での試聴に用いる音声。
  - _**MAY**_ 解釈器はこのプロパティを無視してもよい。
  - 以下はこのプロパティを採用する場合の規定
    - _**MUST**_ 値が`number`の場合、`BaseData.sounds`の対応するIDを示すと解釈する。
    - _**MUST**_ 値が`string`の場合、`filename`がその値であり、それ以外のプロパティが全てデフォルト値である`Sound`として解釈する。
  - _**SHOULD**_ 省略された場合、フォルダ内に`preview`という名前の音声ファイルがあれば、それを試聴音源として利用する。
- `jacket` : `number|string|Image`
  - 選曲画面等で楽曲のイメージを表す一枚絵。
  - 以下は残りの3種の画像プロパティで共通。(_**MUST**_ はこのプロパティを採用する場合の規定)
    - _**MAY**_ 解釈器はこのプロパティを無視してもよい。
    - _**MUST**_ 値が`number`の場合、`BaseData.images`の対応するIDを示すと解釈する。
    - _**MUST**_ 値が`string`の場合、`filename`がその値であり、それ以外のプロパティが全てデフォルト値である`Image`として解釈する。
- `banner` : `number|string|Image`
  - 楽曲一覧等で表示する横長の小さい一枚絵。
- `splash` : `number|string|Image`
  - プレイ画面でロード中に表示される一枚絵(特殊フォントによるタイトル画像など)。
- `background` : `number|string|Image`
  - プレイ画面でプレイ中に背景に表示される一枚絵。

## 音声データ
`Note`(及び必要なら`header.preview`)から参照される音声の情報を保持するデータ型。
```
object Sound
{
	"filename" : string,

	"offset" : number,
	"length" : number,

	"volume" : number,
	"pan"    : number,
	"pitch"  : number,
}
```
- `filename`以外は省略可能。
- `filename` : `string`
  - 対象とするファイルのパス。**拡張子は必須**
  - _**SHOULD**_ このファイルが存在するフォルダからの相対パスである。
    - _**SHOULD**_ `/`をパス区切りとして異なるフォルダを参照することもできる。
  - _**MAY**_ URIとして解釈可能な文字列の場合、Web上のファイルを参照してもよい。
  - _**SHOULD**_ 解釈機は、指定された名前と完全に一致するファイルが見つからない場合、拡張子の異なるファイルを検索し、それで代替する。
    - 例: `hoge.wav`が見つからない場合は`hoge.ogg`を参照する。
	- _**MUST**_ 拡張子以外の部分は**変更してはならない**。
	  - 例: `hoge.wav`が見つからない場合に`fuga.wav`で代替**してはならない**。
  - _**MUST**_ 解釈機は、指定されたファイルが一切見つからない場合、このデータを無音とみなす(エラーにはしない)。
- `offset` : `number`
  - 音声の再生開始位置を**秒単位**で表す。
  - _**MUST**_ 値は`0`と「実際の音声の長さ」との間に矯正する。
- `length` : `number`
  - 音声の再生時間を**秒単位**で表す。
  - _**MUST**_ 指定値が`0`以下の場合(注:プロパティの省略時は`0`である)、それは末尾からの時間とみなす。
    - 例: `0`は再生時間0秒ではなく、元の音声を最後まで再生することを意味する。
	- 例: `-2`は、元の音声の長さから2秒だけ短く再生することを意味する。
  - _**MUST**_ 最終的な値は`0`と「実際の音声の長さ-`offset`」との間に矯正する。
- `volume` : `number`
  - 音声の再生音量を、元々の音量を`100`とした割合で表す。
  - _**MUST**_ 省略された場合は`100`とみなす。
  - _**MUST**_ `0`未満の値は`0`に矯正する。
  - _**MAY**_ 解釈機は、音量の変更が不可能な場合、このプロパティを無視してもよい。
- `pan` : `number`
  - 音声の再生定位を、左端を`-100`、右端を`100`とした割合で表す。
  - _**MUST**_ 値は`-100`と`100`との間に強制する。
  - _**MAY**_ 解釈機は、定位の変更が不可能な場合、このプロパティを無視してもよい。
- `pitch` : `number`
  - 音声の再生速度を、通常を`0`とした**cent単位**で表す。
    - `-1200`で半分の速度、`1200`で2倍の速度を意味する。
	- すなわち、`実際の速度=2^(pitch / 1200)`
  - _**MAY**_ 解釈器は、ピッチの変更が不可能な場合、このプロパティを無視してもよい。

## 映像データ
`MetaNote`などから参照される画像や動画の情報を保持するデータ型。
```
object Image
{
	"filename" : string,

	"offset" : number,
	"length" : number,

	"cx" : number,
	"cy" : number,
	"cw" : number,
	"ch" : number,
}
```
- `filename`以外は省略可能。
- `filename` : `string`
  - 対象とするファイルのパス。**拡張子は必須**
  - _**SHOULD**_ このファイルが存在するフォルダからの相対パスである。
    - _**SHOULD**_ `/`をパス区切りとして異なるフォルダを参照することもできる。
  - _**MAY**_ URIとして解釈可能な文字列の場合、Web上のファイルを参照してもよい。
  - _**SHOULD**_ 解釈機は、指定された名前と完全に一致するファイルが見つからない場合、拡張子の異なるファイルを検索し、それで代替する。
    - 例: `hoge.mpg`が見つからない場合は`hoge.mp4`を参照する。
	- _**MUST**_ 拡張子以外の部分は**変更してはならない**。
	  - 例: `hoge.png`が見つからない場合に`fuga.png`で代替**してはならない**。
  - _**MUST**_ 解釈機は、指定されたファイルが一切見つからない場合、このデータを透明の画像とみなす(エラーにはしない)。
- `offset` : `number`
  - 動画の再生開始位置を`秒単位`で表す。
  - _**MUST**_ 値は`0`と「実際の動画の長さ」との間に矯正する。
  - _**MUST**_ 読み込んだファイルが静止画の場合、「実際の動画の長さ」は`0`である。
- `length` : `number`
  - 動画の再生時間を**秒単位**で表す。
  - _**MUST**_ 指定値が`0`以下の場合(注:プロパティの省略時は`0`である)、それは末尾からの時間とみなす。
    - 例: `0`は再生時間0秒ではなく、元の動画を最後まで再生することを意味する。
	- 例: `-2`は、元の動画の長さから2秒だけ短く再生することを意味する。
  - _**MUST**_ 最終的な値は`0`と「実際の動画の長さ-`offset`」との間に矯正する。
- `cx` : `number`
  - 映像の切り抜き範囲の左端を**ピクセル単位**で表す。
  - _**MUST**_ 値は`0`と「実際の映像の幅」との間に矯正する。
- `cy` : `number`
  - 映像の切り抜き範囲の上端を**ピクセル単位**で表す。
  - _**MUST**_ 値は`0`と「実際の映像の高さ」との間に矯正する。
- `cw` : `number`
  - 映像の切り抜き範囲の幅を**ピクセル単位**で表す。
  - _**MUST**_ 指定値が`0`以下の場合(注:プロパティの省略時は`0`である)、それは右端からのピクセル数とみなす。
    - 例: `0`は幅ゼロではなく、元の映像の全幅を表示することを意味する。
	- 例: `-2`は、元の映像の幅から2ピクセルだけ小さく表示することを意味する。
  - _**MUST**_ 最終的な値は`0`と「実際の映像の幅-`cx`」との間に矯正する。
- `ch` : `number`
  - 映像の切り抜き範囲の高さを**ピクセル単位**で表す。
  - _**MUST**_ 指定値が`0`以下の場合(注:プロパティの省略時は`0`である)、それは下端からのピクセル数とみなす。
  - _**MUST**_ 最終的な値は`0`と「実際の映像の高さ-`cy`」との間に矯正する。

## 指揮者ノート
テンポやスクロール速度の変化に関わる命令を記述するノート。
```
object Conductor
{
	"bpm" : number,
	"stop"  : Rational,
	"scroll" : number,
}
```
- プロパティは全て省略可能(ただし、全て省略した場合そのノートは意味がない)
- `bpm` : `number`
  - 以降の楽曲のテンポを**1分あたりの四分音符の数**(bpm)で表す。
  - _**MUST**_ `0`未満の値は`0`に矯正する。
  - _**MUST**_ `0`は停止ではなく、テンポを変更しないことを意味する(注:プロパティの省略時は`0`である)。
- `stop` : `Rational`
  - この時刻で演奏を停止する期間を**Header.time_base単位**で表す。
  - _**MUST**_ 同じノートで`bpm`が指定されている場合は、`bpm`の変更を先に適用する。
  - _**MUST**_ 負の値は**譜面ワープ**になる(間にあるオブジェクトは全て無視する)。
  - _**SHUOLD**_ 停止するのは新たなノートの処理のみで、既に再生中の音声や動画は停止しない。
- `scroll` : `number`
  - 以降の譜面のスクロール速度を、通常時を`1`とした割合で表す。
  - _**MUST**_ 省略された場合は`0`ではなく、スクロール速度を変更しないと解釈する。
  - _**MUST**_ 値が`0`の場合、実際の演奏は止めないが、見かけ上の譜面スクロールは停止する。
  - _**MUST**_ 値が負の場合、実際の演奏は反転しないが、見かけ上の譜面のスクロールは反転する。

## 音声ノート
実際のゲームプレイに関わるノート。
```
object Note
{
	"y" : Position,
	"x" : number,

	"i" : number,
	"t" : number,
	"g" : number,

	"lt" : number,
	"o" : number,
	"l" : number,
}
```
- `y`以外は省略可能
- `y` : `Position`
  - このノートが存在する時刻。
  - _**MUST**_ 同じ時刻に複数のノートが存在する場合、解釈器はそれらを**1個のノートとして扱う**。
- `x` : `number`
  - このノートを配置するレーン番号。
  - _**MUST**_ `0`以下の場合はBGM扱いで、総ノート数やコンボ数に計上せず、判定も行わない(音声は`y`に応じたタイミングで自動的に再生される)。
  - `1`以上の場合、それを物理的にどのボタンに対応させるかは、解釈器が`Header.chart_type`から判断する。以下は推奨解釈
    - `beat`系の場合 : `1-7`は1P鍵盤、`8`は1Pスクラッチ、`11-17`は2P鍵盤、`18`は2Pスクラッチ
	- `popn`系の場合 : `1-9`は1Pの各ボタン
- `i` : `number`
  - このノートが参照する`BaseData.sounds`のID。
  - _**MUST**_ `0`または`sounds`に対応するキーが存在しない場合、解釈器はこれを無音ノートとみなす。(注:プロパティの省略時は`0`である)
    - `sounds`のID`0`番は`Note`からは参照できない。
- `t` : `number`
  - ノートタイプを表す数値。
  - _**MUST**_ 値の解釈は以下の通り。
    - `0` : 通常ノート
	- `1` : 不可視ノート
	  - 総ノート数やコンボ数に計上せず、判定も行わず、**音声の自動再生も行わない**。
	  - 該当レーンのボタンを押した時に音声の再生のみ行う。
	- `2` : ロングノート終端
	  - 同じレーンの直前のノートが通常ノートの場合、そのノートをロングノート化する。
	  - 同じレーンの直前のノートが通常ノートではない場合、このノートは無視する。
	  - `i`が`0`でない場合、このノートを処理(ボタンを離)したときにその音声を再生する。
- `g` : `number`
  - このノートを最高判定で処理した場合のゲージ回復量。
  - _**MUST**_ 省略された場合は`Header.total`に従う。
  - _**MUST**_ 値が負の場合はその分のダメージを受ける**地雷ノート**として扱う。
    - _**SHOULD**_ 地雷ノートは通常ノートとは異なる見た目で描画する。
- `lt` : `number`
  - ロングノートの形式。各値の解釈は`Header.ln_type`を参照。
  - _**MUST**_ 最終的なロングノート形式は以下の優先度で解決される。
    1. 終端ノートで指定された`lt`の値
	2. 始端ノートで指定された`lt`の値
	3. `Header.ln_type`で指定された値
	4. 解釈器の規定の値
- `o` : `number`
  - 音声の再生開始位置を**秒単位**で表す。
  - _**MUST**_ 同じIDの音声が再生中でない場合
    - `Sound.offset`と合計した位置から再生を開始する。
    - 最終的な値は`0`と「実際の音声の長さ」との間に矯正する。
  - _**MUST**_ 同じIDの音声が再生中の場合
    - 指定値が`0`以上の場合は再生中の音声を停止し、改めて再生中でない場合と同じように再生する。
	  - 指定値が負の場合
      - このノートが処理(ボタンが押)された場合、再生中の音声は停止せず現在の位置からそのまま演奏し続ける。
  	  - このノートが処理されなかった場合、再生中の音声を停止する。
- `l` : `number`
  - 音声の再生時間を**秒単位**で表す。
  - _**MUST**_ 指定値が`0`より大きい場合、`Sound.length`の指定を無視してその時間だけ再生する。
  - _**MUST**_ 指定値が`0`以下の場合(注:プロパティの省略時は`0`である)、`Sound.length`と合計した時間だけ再生する。
    - この場合、`Sound.length`と同じかより短い時間だけ演奏することになる。

## メタノート
ゲームプレイには直接関わらないが、楽曲の演奏に伴って処理されるノート。
```
object MetaNote
{
	"y" : Position,
	"x" : number,

	"i" : number,
	"v" : string,

	"dx" : number,
	"dy" : number,
	"ox" : number,
	"oy" : number,
	"angle" : number,
	"ax" : number,
	"ay" : number,
}
```
- `y`以外は省略可能
- `y` : `Position`
  - このノートが存在する時刻。
  - _**MUST**_ 同じ時刻に複数のノートが存在する場合、記述された順に適用する。
    - 結果として最後に記述されたノートのみが適用される。
- `x` : `number`
  - このメタノートが適用される対象チャンネル。
  - _**MUST**_ 以下の値はBGAチャンネルとして予約されている。
    - `1` : ベースBGA
	- `2`-`8` : レイヤー1-7
	- `9` : ミスレイヤー
    - 上記以外のチャンネルについては、解釈器は独自に解釈してよい。
  - _**MUST**_ 各レイヤーで一度適用(表示)された映像は、次に同じレイヤーに別の映像が適用されるまで表示し続ける。動画の場合、最後まで再生した後は最後のフレームを表示し続ける。
  - _**MUST**_ 各レイヤーは映像の透過情報を考慮してアルファブレンドする。動画の場合、動画がアルファに対応していなければ透過しなくてよい。
  - _**SHOULD**_ ミスレイヤーに適用された動画は、ミスレイヤーが表示される度に最初から再生しなおす。
- `i` : `number`
  - 数値として表現されるこのノートの値。
  - _**MUST**_ `x`がBGAチャンネルの場合、これはこのノートが参照する`BaseData.images`のIDである。
    - _**MUST**_ `0`または`images`に対応するキーが存在しない場合、そのレイヤーに表示されている映像を消す。(注:プロパティの省略時は`0`である)
    - `images`のID`0`番は`MetaNote`からは参照できない。
- `v` : `string`
  - 文字列として表現されるこのノートの値。
  - この値をどう解釈するかは解釈器に委ねられる。
- `dx` : `number`, `dy` : `number`
  - BGAチャンネルにおいて、この映像の描画位置を**ピクセル単位**で表す。
  - _**MUST**_ 描画領域の**中心**を`(0,0)`とする。
- `ox` : `number`, `oy` : `number`
  - BGAチャンネルにおいて、この映像の描画基準位置を**ピクセル単位**で表す。
  - _**MUST**_ 省略時は切り抜き適用後の幅と高さのそれぞれ`1/2`(小数点以下切り捨て)とみなす。
- `angle` : `number`
  - BGAチャンネルにおいて、この映像を回転する角度を**degree単位**で表す。
  - _**MUST**_ 回転は**時計回り**を正とする。
  - _**MAY**_ 解釈機は、回転描画が不可能な場合、このプロパティを無視してもよい。
- `ax` : `number`, `ay` : `number`
  - 回転の中心。
  - _**MUST**_ 省略した場合はそれぞれ`ox` `oy`と同じとみなす。

# 数式の記法
- `XbmData.params`及び`BranchData.condition`に記述する数式について、以下のように規定する。以下の規定で、特に明記のない仕様は全て _**MUST**_ である。

## 数式の定義
- 「数式」とは任意数のトークンからなる文字列である。
- 数式にはASCII印字可能文字(0x20` `-0x7E`~`)のみが使用可能である。
  - ASCII制御文字やASCII範囲外の文字が出現した際の動作は定義しない。
  - ASCII制御文字が含まれる場合、その数式は不正なものとみなす。
    - 注: JSONは印字可能文字のみ利用できるため、そのような文字列は普通は存在しえない。
  - _**MAY**_ ASCII範囲外の文字を解釈可能な文字に含めてもよい。
- 空文字列または不正な数式の評価値は`0`である。
- 数式の評価値は**最後に評価された値**である。
  - 例: `1 2 3` とだけ記述された(演算子や関数の無い)「数式」の評価値は`3`である。
- 値は全て倍精度浮動小数点数として計算を行う。

## トークンの種類
- 解釈器は、少なくとも下記のトークン全てを区別し解釈できる必要がある。

|表現|トークン|解釈失敗時
|---|---|---|
|`(` `[` `{`|開き括弧|不正な式
|`)` `]` `}`|閉じ括弧|不正な式
|`,`|引数区切り|不正な式
|`A`-`Z` `_` `a`-`z`で始まる識別子|関数または変数|`0`を返す関数とみなす
|`.` `0`-`9`で始まる識別子|数値|不正な式
|その他の記号列|演算子|単項演算子: 引数をそのまま返す<br>二項演算子: `0`を返す

### 各トークンの詳細
- ` ` : スペース
  - トークンの境界(スペース自身はトークンではない)。
  - スペースは何個あっても数式の評価に一切影響しない。
  - _**MAY**_ ASCII範囲外で空白とみなせる文字はスペース扱いしてもよい。
- `(` `[` `{` : 開き括弧トークン
  - スコープの開始を表すトークン。
  - 最も内側の括弧内を最優先で評価する。
  - 種類による処理の違いは無いが、直後の閉じ括弧が同じ種類(例: `(`に対しては`)`)でなければならない。
  - _**MAY**_ ASCII範囲外で括弧とみなせる文字の組は括弧トークン扱いしてもよい。
  - 対応する閉じ括弧トークンが見つからない場合、不正な式とみなす。
- `)` `]` `}` : 閉じ括弧トークン
  - スコープの終了を表すトークン。
  - これより前に開き括弧トークンが存在しない(数が合わない)か、存在しても種類が異なる場合は、不正な式とみなす。
    - 例: `([]{})`は「正常」な数式である。
	- 例: `([{]})`は不正な数式である(`{`が閉じる前に`]`が出現している)。
- `,` : 引数区切りトークン
  - 一つ前の開き括弧トークンまたは引数区切りトークンからこのトークンまでの区間をスコープとして確定する。
    - 例: `(1 + 2)` は1個の値(`3`)を表すが、`(1, + 2)`は`1`と`2`という2つの値を表す(`+`は単項プラス演算子とみなされる)。
  - これより前に開き括弧トークンまたは別の引数区切りトークンが存在しない場合、不正な式とみなす。
- `A`-`Z` `_` `a`-`z` で始まる識別子 : 関数トークン または 変数トークン
  - 「識別子」とは、正規表現`[.0-9A-Z_a-z]+`にマッチするような文字列のことである。
    - 英数字に加えて`.`と`_`が識別子文字とみなされる。
    - _**MAY**_ ASCII範囲外で通常の文字とみなせる文字は識別子に含めてもよい。
  - 直後のトークンが開き括弧である場合は**関数トークン**とみなす。そうでなければ**変数トークン**とみなす。
	- `foo()`は引数0個の**関数トークン**だが、(括弧のない)`foo`は**変数トークン**である。
  - 関数トークンは識別子と引数の数で区別される。
    - `foo()`と`foo(a, b)`は異なる関数とみなされる(内部処理は同じ可能性がある)。
	- 引数の数は、対応する閉じ括弧トークンが出現した時点で確定される。
    - 識別子と引数の数が一致する関数が存在しない場合、(不正な式ではなく)そのトークンは`0`を返す関数とみなす。
  - 変数トークンは、対応する変数が定義されていない場合、(不正な式ではなく)`0`とみなす。
- `.` `0`-`9` で始まる識別子 : 数値トークン
  - 先頭の1文字を除いて、数値トークンには関数/変数トークンと同じ文字が利用される。
    - _**MAY**_ ASCII範囲外で数字とみなせる文字は数値トークンの開始とみなしてもよい。
  - 数値トークンは、それを数値として解釈できない場合、**不正な式とみなす**。
	- 例: `.AtoZ`は **`.`で始まるので数値トークンである**が、ほとんどの環境でこれは数値として解釈できない。
	- 数値として解釈できない数値トークンを関数や変数とみなしてはならない。
- その他の記号列 : 演算子トークン
  - 「その他の記号」とは上記のトークンに使用されない文字(`` !"#$%&'+*-/:;<=>?@\^`|~ ``)のことであり、それら記号のみが連続したものを「記号列」と呼ぶ。
    - _**MAY**_ ASCII範囲外で記号とみなせる文字はその他の記号に含めてもよい。
  - 一連の記号列を1個の演算子として扱う。
    - 例: `+`と`++`は異なる演算子である。
	- 例: `+ +`と`++`は意味が異なる(前者は`+`演算子が2つ並んだものであり、通常は不正な数式である)。
  - 演算子には以下の3種類が存在する。
    - 単項演算子
	  - 1つの引数の直前に記述される。
	  - 例: `-a`(単項マイナス)
	- 二項演算子
	  - 2つの引数の間に記述される。
	  - 例: `a + b`(加法演算子)
	- 三項演算子
	  - 3つの引数をそれぞれ区切るように、分けて記述される。
	  - 例: `a ? b : c`(条件演算子)
	  - 「三項演算子の記号列」は1種類の演算子につき2個存在する。これの解釈手順は開き括弧と閉じ括弧との対応に類似する。
	    - 第1記号(`?`など)が存在し、それに対応する第2記号(`:`など)が見つからない場合、不正な数式とみなす。
		- 第2記号の出現時、それより前に三項演算子の第1記号が存在しない(数が合わない)か、存在しても種類が異なる場合は、不正な数式とみなす。
		- 第1記号と第2記号が括弧で分断されている場合は、不正な数式とみなす。
  - 単項演算子とそれ以外は文脈から明確に区別可能である。
    - 直前のトークンが「閉じ括弧」 「変数」 「数値」のいずれかの場合、それは二項演算子または三項演算子とみなせる。
	- それ以外の場合、それは単項演算子とみなせる。
	- 従って、単項演算子はその他の演算子と同じ記号列を用いてもよい。
	- 二項演算子と三項演算子は同じ記号列を用いてはならない。
  - 括弧で囲まれていない演算子は、予め規定された「優先度」と「結合性」に従って評価の順序を決める。
    - 例: `a + b ^ c + d ^ e ^ f`
	- `+`は優先度の低い左結合演算子、`^`は優先度の高い右結合演算子とする。
	- この式は `(a + (b ^ c)) + (d ^ (e ^ f))`と等価である。
	- 優先度と結合性の扱いについては後述する。
  - 対応する演算子が定義されていない場合、(不正な式ではなく)以下のようにみなす。
    - 単項演算子: 引数をそのまま返す優先度`100`の`右`結合性演算子
    - それ以外: `0`を返す優先度`60`の`左`結合性二項演算子

## 関数
- 解釈器は、少なくとも下記の表における`param`と`rand`を実装しなければならない。
  - _**SHOULD**_ 解釈器は、可能な限り下記の関数を全て実装する。
- 挙げられていない関数を独自に定義することは可能だが、識別子と引数は重複してはならない。

|識別子|引数|記述例|戻り値|
|-|-|-|-|
|`param`|1|`param(i)`|`XbmData.params[i]`の評価値<br>未定義の場合は`0`
|`int`|1|`int(x)`|引数の整数部分(truncate)<br>`int(1.5)`=`1` `int(-2.3)`=`-2`|
|`max`|2|`max(x, y)`|`x`と`y`のうち大きい方|
|`min`|2|`min(x, y)`|`x`と`y`のうち小さい方|
|`rand`|1|`rand(n)`|`0`以上`n`未満のランダムな整数|
- `param(i)`は対応するキーが未定義の場合は`0`を返す。
  - `XbmData.params`の各数式の評価順は規定されない。
  - 例: `"params":{"0":"param(1)+1", "1":"param(0)+1"}`
    - `params[0]`を先に評価する場合、この時点で`params[1]`は未定義なため、評価値は`0+1`=`1`。
	- `params[1]`の評価時点で`params[0]`は`1`なため、評価値は`1+1`=`2`。
	- `params[1]`を先に評価する場合、上記と逆の状態となるため、評価値は`params[0]`=`2` `params[1]`=`1`となる。
  - 評価の順番(解釈器の任意)によって評価値が変わるため、`XbmData.params`の内部で`param(i)`を使用してはならない(規格上の制限ではない)。
- `XbmData.params`及び`BranchData.condition`の各数式は一度だけ評価される。
  - `rand`の評価も各数式につき1回だけ行われ、その時点で値が確定するため、その数式を複数回参照しても常に同じ値になる。

## 演算子
- 解釈器は、最低でも下記の表における`&` `=`を実装しなければならない。
  - _**SHOULD**_ 解釈器は、可能な限り下記の演算子を全て実装する。
- 挙げられていない演算子を独自に定義することは可能だが、記号列が重複してはならない。

### 単項演算子
- 単項演算子は引数の直前に記述される。
- 数式の解釈後は、これは1引数の関数とみなせる。

|記号列|記述例|意味|優先度|結合性|備考|
|-|-|-|-|-|-|
|`+`|`+a`|単項プラス|100|右|
|`-`|`-a`|単項マイナス|100|右|
|`!`|`!a`|否定|100|右|`a`が`0`なら`1`、それ以外なら`0`を返す

### 二項演算子
- 二項項演算子は2つの引数の中間に記述される。
- 数式の解釈後は、これは2引数の関数とみなせる。

|記号列|記述例|意味|優先度|結合性|備考|
|-|-|-|-|-|-|
|`+`|`a + b`|和|60|左|
|`-`|`a - b`|差|60|左|
|`*`|`a * b`|積|61|左|
|`/`|`a / b`|商|61|左|_**MAY**_ `b`が`0`の場合、エラーにしてもよい
|`%`|`a % b`|剰余|61|左|_**MAY**_ `b`が`0`の場合、エラーにしてもよい
|`**`|`a ** b`|累乗|62|右|_**MAY**_ `a`が負で`b`が非整数の場合、エラーにしてもよい
|
|`<`|`a < b`|未満|40|左|`a`が`b`より小さければ`1`、そうでなければ`0`を返す
|`<=`|`a <= b`|以下|40|左|`a`が`b`と等しいかより小さければ`1`、そうでなければ`0`を返す
|`>`|`a > b`|超過|40|左|`a`が`b`より大きければ`1`、そうでなければ`0`を返す
|`>=`|`a >= b`|以上|40|左|`a`が`b`と等しいかより大きければ`1`、そうでなければ`0`を返す
|`<=>`|`a <=> b`|比較|40|左|`a`が`b`より小さければ`-1`、大きければ`1`、等しければ`0`を返す
|
|`=`|`a = b`|相等|30|左|`a`と`b`が等しければ`1`、等しくなければ`0`を返す
|`==`|`a == b`|相等|30|左|`=`と意味は同じ
|`!`|`a ! b`|相違|30|左|`a`と`b`が等しければ`0`、等しくなければ`1`を返す
|`!=`|`a != b`|相違|30|左|`!`と意味は同じ
|
|`&`|`a & b`|論理積|12|左|`a`が`0`なら`0`、そうでなければ`b`を返す
|`&&`|`a && b`|論理積|12|左|`&`と意味は同じ
|`\|`|`a \| b`|論理和|10|左|`a`が`0`なら`b`、そうでなければ`a`を返す
|`\|\|`|`a \|\| b`|論理和|10|左|`\|`と意味は同じ
|`^`|`a ^ b`|排他的論理和|11|左|`a`が`0`なら`b`、そうでなく`b`が`0`なら`a`、そうでもでなければ`0`を返す

### 三項演算子
- 三項演算子は3つの引数を区切るように2つに分けて記述される。
- 数式の解釈後は、これは3引数の関数とみなせる。

|第1記号|第2記号|記述例|意味|優先度|結合性|備考|
|-|-|-|-|-|-|-|
|`?`|`:`|`a ? b : c`|条件分岐|0|右|`a`が`0`なら`c`、そうでなければ`b`を返す